name: Deploy Telegram Subscription Bot

on:
  push:
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            echo "ðŸš€ Starting deployment from GitHub..."
            
            # Install/ensure Docker Compose v2 (manual curl method, idempotent)
            echo "ðŸ³ Ensuring Docker Compose v2 is installed..."
            if ! docker compose version &> /dev/null; then
              echo "ðŸ“¥ Creating directory and downloading Docker Compose v2 plugin..."
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              sudo curl -SL https://github.com/docker/compose/releases/download/v2.40.0/docker-compose-linux-$(uname -m) -o /usr/local/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
              echo "âœ… Docker Compose v2 installed!"
            else
              echo "âœ… Docker Compose v2 already available."
            fi
            
            # Cleanup and prepare
            docker system prune -f
            mkdir -p /root/subscription-backend
            cd /root/subscription-backend
            
            # Use Git instead of file copying
            echo "ðŸ”‘ Setting up Git authentication..."
            export GITHUB_PAT="${{ secrets.GITHUB_PAT }}"
            
            if [ -d ".git" ]; then
              echo "ðŸ“¥ Pulling latest changes..."
              git remote set-url origin https://$GITHUB_PAT@github.com/mkisten/subscription-backend.git
              git pull origin master
            else
              echo "ðŸ“¥ Cloning repository..."
              git clone https://$GITHUB_PAT@github.com/mkisten/subscription-backend.git /root/subscription-backend-temp
              mv /root/subscription-backend-temp/.git ./
              git reset --hard
              rm -rf /root/subscription-backend-temp
            fi
            
            unset GITHUB_PAT
            
            # Create .env
            echo "ðŸ”§ Creating .env file..."
            cat > .env << EOF
              # Admin Configuration
              ADMIN_CHAT_ID=6927880904

              # Database Configuration
              SUBSCRIPTION_POSTGRES_DB=subscription_db
              SUBSCRIPTION_POSTGRES_USER=postgres
              SUBSCRIPTION_POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}

              VACANCY_POSTGRES_DB=vacancy_service
              VACANCY_POSTGRES_USER=postgres
              VACANCY_POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}

              # JWT Configuration
              JWT_SECRET=${{ secrets.JWT_SECRET }}
              JWT_EXPIRATION=86400

              # Telegram Bot Configuration
              TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
              TELEGRAM_BOT_USERNAME=hhsubscription_bot

              # Application Configuration
              FRONTEND_URL=http://localhost:3000
              SERVER_PORT=8080
              AUTH_SERVICE_URL=http://subscription_app:8080
            EOF
            sed -i 's/^  //' .env

            # Deploy containers
            echo "ðŸ”¨ Building and starting containers..."
            docker compose down
            docker compose build --no-cache
            docker compose up -d
            
            # Health check with retry
            echo "ðŸ¥ Performing health check..."
            for i in {1..10}; do
              if curl -f http://localhost:8080/actuator/health; then
                echo "âœ… Health check passed!"
                break
              fi
              echo "â³ Health check failed, retrying in 10s... (attempt $i/10)"
              sleep 10
            done
            
            echo "ðŸš€ Telegram Subscription Bot deployed successfully from GitHub!"
            echo "ðŸ“Š Checking container status:"
            docker compose ps
            echo "ðŸ’¾ Disk usage:"
            df -h
