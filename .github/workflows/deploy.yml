name: Deploy Telegram Subscription Bot

on:
  push:
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            echo "üöÄ Starting deployment from GitHub..."
            
            # Install/ensure Docker Compose v2 (manual curl method, idempotent)
            echo "üê≥ Ensuring Docker Compose v2 is installed..."
            if ! docker compose version &> /dev/null; then
              echo "üì• Creating directory and downloading Docker Compose v2 plugin..."
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              sudo curl -SL https://github.com/docker/compose/releases/download/v2.40.0/docker-compose-linux-$(uname -m) -o /usr/local/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
              echo "‚úÖ Docker Compose v2 installed!"
            else
              echo "‚úÖ Docker Compose v2 already available."
            fi
            
            # Cleanup and prepare
            docker system prune -f
            mkdir -p /root/subscription-backend
            cd /root/subscription-backend
            
            # Use Git instead of file copying
            echo "üîë Setting up Git authentication..."
            export GITHUB_PAT="${{ secrets.GITHUB_PAT }}"
            
            if [ -d ".git" ]; then
              echo "üì• Pulling latest changes..."
              git remote set-url origin https://$GITHUB_PAT@github.com/mkisten/subscription-backend.git
              git checkout -- Dockerfile docker-compose.yml
              if ! git diff --quiet || ! git diff --cached --quiet; then
                echo "üì¶ Stashing local changes..."
                git stash push -u -m "deploy-autostash"
                STASHED=1
              else
                STASHED=0
              fi
              git pull origin master
              if [ "$STASHED" -eq 1 ]; then
                echo "üì¶ Restoring stashed changes..."
                if ! git stash pop; then
                  echo "‚ùå Stash pop failed due to conflicts. Resolve on server and rerun deploy."
                  exit 1
                fi
              fi
            else
              echo "üì• Cloning repository..."
              git clone https://$GITHUB_PAT@github.com/mkisten/subscription-backend.git /root/subscription-backend-temp
              mv /root/subscription-backend-temp/.git ./
              git reset --hard
              rm -rf /root/subscription-backend-temp
            fi
            
            unset GITHUB_PAT
            
            # Create or update .env without wiping custom values (e.g., GRAYLOG_*)
            echo "üîß Ensuring .env file..."
            if [ ! -f .env ]; then
              touch .env
            fi

            upsert_env() {
              local key="$1"
              local value="$2"
              if grep -q "^${key}=" .env; then
                sed -i "s|^${key}=.*|${key}=${value}|" .env
              else
                echo "${key}=${value}" >> .env
              fi
            }

            upsert_env "ADMIN_CHAT_ID" "6927880904"

            upsert_env "SUBSCRIPTION_POSTGRES_DB" "subscription_db"
            upsert_env "SUBSCRIPTION_POSTGRES_USER" "postgres"
            upsert_env "SUBSCRIPTION_POSTGRES_PASSWORD" "${{ secrets.POSTGRES_PASSWORD }}"

            upsert_env "VACANCY_POSTGRES_DB" "vacancy_service"
            upsert_env "VACANCY_POSTGRES_USER" "postgres"
            upsert_env "VACANCY_POSTGRES_PASSWORD" "${{ secrets.POSTGRES_PASSWORD }}"

            upsert_env "JWT_SECRET" "${{ secrets.JWT_SECRET }}"
            upsert_env "JWT_EXPIRATION" "86400"

            upsert_env "TELEGRAM_BOT_TOKEN" "${{ secrets.TELEGRAM_BOT_TOKEN }}"
            upsert_env "TELEGRAM_BOT_USERNAME" "hhsubscription_bot"

            upsert_env "FRONTEND_URL" "http://localhost:3000"
            upsert_env "SERVER_PORT" "8080"
            upsert_env "AUTH_SERVICE_URL" "https://api.subscriptionhhapp.ru"

            # Deploy containers
            echo "üî® Building and starting containers..."
            docker compose down
            docker compose build --no-cache
            docker compose up -d
            
            # Health check with retry
            echo "üè• Performing health check..."
            for i in {1..10}; do
              if curl -f http://localhost:8080/actuator/health; then
                echo "‚úÖ Health check passed!"
                break
              fi
              echo "‚è≥ Health check failed, retrying in 10s... (attempt $i/10)"
              sleep 10
            done
            
            echo "üöÄ Telegram Subscription Bot deployed successfully from GitHub!"
            echo "üìä Checking container status:"
            docker compose ps
            echo "üíæ Disk usage:"
            df -h
