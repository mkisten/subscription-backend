name: Deploy Telegram Subscription Bot

on:
  push:
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            echo "ðŸš€ Starting deployment from GitHub..."
            
            # Install/ensure Docker Compose v2 (manual curl method, idempotent)
            echo "ðŸ³ Ensuring Docker Compose v2 is installed..."
            if ! docker compose version &> /dev/null; then
              echo "ðŸ“¥ Creating directory and downloading Docker Compose v2 plugin..."
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              sudo curl -SL https://github.com/docker/compose/releases/download/v2.40.0/docker-compose-linux-$(uname -m) -o /usr/local/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
              echo "âœ… Docker Compose v2 installed!"
            else
              echo "âœ… Docker Compose v2 already available."
            fi
            
            # Cleanup and prepare
            docker system prune -f
            mkdir -p /root/subscription-backend
            cd /root/subscription-backend
            
            # Use Git instead of file copying
            echo "ðŸ”‘ Setting up Git authentication..."
            export GITHUB_PAT="${{ secrets.GITHUB_PAT }}"
            
            if [ -d ".git" ]; then
              echo "ðŸ“¥ Pulling latest changes..."
              git remote set-url origin https://$GITHUB_PAT@github.com/mkisten/subscription-backend.git
              git pull origin master
            else
              echo "ðŸ“¥ Cloning repository..."
              git clone https://$GITHUB_PAT@github.com/mkisten/subscription-backend.git /root/subscription-backend-temp
              mv /root/subscription-backend-temp/.git ./
              git reset --hard
              rm -rf /root/subscription-backend-temp
            fi
            
            unset GITHUB_PAT
            
            # Create .env
            echo "ðŸ”§ Creating .env file..."
            cat > .env << EOF
              # Admin Configuration
              ADMIN_CHAT_ID=6927880904

              # Database Configuration
              POSTGRES_DB=subscription_db
              POSTGRES_USER=postgres
              POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}

              # JWT Configuration
              JWT_SECRET=${{ secrets.JWT_SECRET }}
              JWT_EXPIRATION=86400

              # Telegram Bot Configuration
              TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
              TELEGRAM_BOT_USERNAME=hhsubscription_bot

              # Application Configuration
              FRONTEND_URL=http://localhost:3000
              SERVER_PORT=8080
            EOF
            sed -i 's/^  //' .env

            # Create init.sql for database
            echo "ðŸ—„ï¸ Creating init.sql..."
            cat > init.sql << 'EOF'
              -- Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Telegram Ð±Ð¾Ñ‚Ð° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº
              CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
              SET timezone = 'UTC';

              COMMENT ON DATABASE subscription_db IS 'Database for Telegram subscription bot backend';

              -- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° payment_history (Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹)
              CREATE TABLE IF NOT EXISTS payment_history (
                id BIGSERIAL PRIMARY KEY,
                amount DECIMAL(10,2) NOT NULL,
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                currency VARCHAR(3) NOT NULL DEFAULT 'USD',
                payment_date TIMESTAMP,
                payment_provider VARCHAR(50),
                status VARCHAR(20) NOT NULL,
                subscription_plan VARCHAR(50),
                transaction_id VARCHAR(100) UNIQUE,
                user_id BIGINT NOT NULL
              );

              -- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° users (Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸)
              CREATE TABLE IF NOT EXISTS users (
                id BIGSERIAL PRIMARY KEY,
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                email VARCHAR(255),
                first_name VARCHAR(100),
                last_login_at TIMESTAMP,
                last_name VARCHAR(100),
                phone VARCHAR(20),
                subscription_end_date TIMESTAMP,
                subscription_plan VARCHAR(50),
                telegram_id BIGINT UNIQUE NOT NULL,
                trial_used BOOLEAN NOT NULL DEFAULT FALSE,
                username VARCHAR(100),
                role VARCHAR(20) NOT NULL DEFAULT 'USER',
                updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                subscription_active BOOLEAN NOT NULL DEFAULT FALSE
              );

              -- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° messages (ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ)
              CREATE TABLE IF NOT EXISTS messages (
                id BIGSERIAL PRIMARY KEY,
                content TEXT NOT NULL,
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                direction VARCHAR(10) NOT NULL CHECK (direction IN ('IN', 'OUT')),
                message_type VARCHAR(20) NOT NULL,
                telegram_id BIGINT NOT NULL
              );

              -- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° auth_sessions (ÑÐµÑÑÐ¸Ð¸ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸)
              CREATE TABLE IF NOT EXISTS auth_sessions (
                id BIGSERIAL PRIMARY KEY,
                session_id VARCHAR(36) UNIQUE NOT NULL,
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                device_id VARCHAR(255) NOT NULL,
                jwt_token TEXT,
                status VARCHAR(20) NOT NULL,
                telegram_id BIGINT,
                updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                completed_at TIMESTAMP,
                expires_at TIMESTAMP
              );

              -- Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° payments (Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð¸)
              CREATE TABLE IF NOT EXISTS payments (
                id BIGSERIAL PRIMARY KEY,
                admin_notes TEXT,
                amount DECIMAL(10,2) NOT NULL,
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                months INTEGER NOT NULL,
                phone_number VARCHAR(20),
                plan VARCHAR(50),
                status VARCHAR(20) NOT NULL,
                telegram_id BIGINT NOT NULL,
                verified_at TIMESTAMP
              );

              -- Ð˜Ð½Ð´ÐµÐºÑÑ‹
              CREATE INDEX IF NOT EXISTS idx_payment_history_user_id ON payment_history(user_id);
              CREATE INDEX IF NOT EXISTS idx_payment_history_status ON payment_history(status);
              CREATE INDEX IF NOT EXISTS idx_users_telegram_id ON users(telegram_id);
              CREATE INDEX IF NOT EXISTS idx_users_subscription_end_date ON users(subscription_end_date);
              CREATE INDEX IF NOT EXISTS idx_auth_sessions_telegram_id ON auth_sessions(telegram_id);
              CREATE INDEX IF NOT EXISTS idx_payments_telegram_id ON payments(telegram_id);

              -- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ updated_at
              CREATE OR REPLACE FUNCTION update_updated_at_column()
              RETURNS TRIGGER AS $$
              BEGIN
                NEW.updated_at = CURRENT_TIMESTAMP;
                RETURN NEW;
              END;
              $$ language 'plpgsql';

              CREATE TRIGGER update_users_updated_at
                BEFORE UPDATE ON users
                FOR EACH ROW
                EXECUTE FUNCTION update_updated_at_column();

              CREATE TRIGGER update_auth_sessions_updated_at
                BEFORE UPDATE ON auth_sessions
                FOR EACH ROW
                EXECUTE FUNCTION update_updated_at_column();
            EOF
            sed -i 's/^  //' init.sql

            # Create docker-compose.yml
            echo "ðŸ³ Creating docker-compose.yml..."
            cat > docker-compose.yml << 'EOF'
              version: '3.8'

              services:
                postgres:
                  image: postgres:15-alpine
                  container_name: subscription_postgres
                  environment:
                    POSTGRES_DB: ${POSTGRES_DB}
                    POSTGRES_USER: ${POSTGRES_USER}
                    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
                  ports:
                    - "5432:5432"
                  volumes:
                    - postgres_data:/var/lib/postgresql/data
                    - ./init.sql:/docker-entrypoint-initdb.d/init.sql
                  networks:
                    - subscription_network
                  healthcheck:
                    test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
                    interval: 30s
                    timeout: 10s
                    retries: 3

                app:
                  build: .
                  container_name: subscription_backend
                  ports:
                    - "8080:8080"
                  environment:
                    - SPRING_PROFILES_ACTIVE=docker
                    - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/${POSTGRES_DB}
                    - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER}
                    - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}
                    - JWT_SECRET=${JWT_SECRET}
                    - JWT_EXPIRATION=${JWT_EXPIRATION}
                    - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
                    - TELEGRAM_BOT_USERNAME=${TELEGRAM_BOT_USERNAME}
                    - ADMIN_CHAT_ID=${ADMIN_CHAT_ID}
                    - SERVER_PORT=8080
                    - SERVER_SSL_ENABLED=false
                  depends_on:
                    postgres:
                      condition: service_healthy
                  networks:
                    - subscription_network
                  restart: unless-stopped
                  healthcheck:
                    test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
                    interval: 30s
                    timeout: 10s
                    retries: 3
                    start_period: 40s

              volumes:
                postgres_data:

              networks:
                subscription_network:
                  driver: bridge
            EOF
            sed -i 's/^  //' docker-compose.yml

            # Create Dockerfile
            echo "ðŸ‹ Creating Dockerfile..."
            cat > Dockerfile << 'EOF'
              FROM eclipse-temurin:17-jdk-alpine as builder

              WORKDIR /app

              COPY mvnw .
              RUN chmod +x mvnw

              COPY .mvn .mvn
              COPY pom.xml .

              RUN ./mvnw dependency:go-offline -B

              COPY src ./src

              RUN ./mvnw clean package -DskipTests

              FROM eclipse-temurin:17-jre-alpine

              WORKDIR /app

              RUN addgroup -S spring && adduser -S spring -G spring
              USER spring:spring

              COPY --from=builder /app/target/*.jar app.jar

              ENV JAVA_OPTS="-Xmx512m -Xms256m -Djava.security.egd=file:/dev/./urandom"

              HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
                CMD curl -f http://localhost:8080/actuator/health || exit 1

              EXPOSE 8080

              ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar"]
            EOF
            sed -i 's/^  //' Dockerfile

            # Deploy containers
            echo "ðŸ”¨ Building and starting containers..."
            docker compose down
            docker compose build --no-cache
            docker compose up -d
            
            # Health check with retry
            echo "ðŸ¥ Performing health check..."
            for i in {1..10}; do
              if curl -f http://localhost:8080/actuator/health; then
                echo "âœ… Health check passed!"
                break
              fi
              echo "â³ Health check failed, retrying in 10s... (attempt $i/10)"
              sleep 10
            done
            
            echo "ðŸš€ Telegram Subscription Bot deployed successfully from GitHub!"
            echo "ðŸ“Š Checking container status:"
            docker compose ps
            echo "ðŸ’¾ Disk usage:"
            df -h
